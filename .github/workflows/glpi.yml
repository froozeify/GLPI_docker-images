name: "GLPI images for official releases"

on:
  # Enable manual run
  #
  # It can be executed by a curl command:
  #
  # curl -X POST \
  # -H "Accept: application/vnd.github.v3+json" \
  # -H "Authorization: <access-token>" \
  # https://api.github.com/repos/glpi-project/docker-images/actions/workflows/<workflow-id>/dispatches \
  # -d '{"ref":"main", "inputs": { "glpi-version":"11.0.5", "push": true }}'
  workflow_dispatch:
    inputs:
      push:
        description: "Whether to push images to registries"
        required: false
        type: boolean
        default: false
      php-version:
        description: "PHP version to use for the build"
        required: false
        type: string
        default: "8.5"
      glpi-version:
        description: "GLPI version (tag: '11.0.5'), branch ('main', '11.0/bugfixes'), commit hash, or URL"
        required: true
        type: string
      image-suffix:
        description: "Suffix to add to the image name, i.e: 'nightly'"
        required: false
        type: string
        default: ""
      image-tag:
        description: "Override image tag (ignores version computation). i.e: '11.0.5-beta1'"
        required: false
        type: string
        default: ""
      patch-url:
        description: "Optional patch URL(s) to apply. Multiple patches: separate with spaces"
        required: false
        type: string
        default: ""

jobs:
  build:
    name: "Build GLPI ${{ inputs.glpi-version }}"
    uses: ./.github/workflows/_glpi-build.yml
    with:
      push: ${{ inputs.push }}
      php-version: ${{ inputs.php-version }}
      glpi-version: ${{ inputs.glpi-version }}
      image-suffix: ${{ inputs.image-suffix }}
      image-tag: ${{ inputs.image-tag }}
      # Combine manual patch-url input with automatic version-based patches
      # Format: Use startsWith() for ranges, exact match for single versions
      # Multiple patches: separate URLs with spaces
      patch-url: >-
        ${{ inputs.patch-url }}
        ${{
          (startsWith(inputs.glpi-version, '11.0.') && inputs.glpi-version < '11.0.5')
          && 'https://patch-diff.githubusercontent.com/raw/glpi-project/glpi/pull/22381.diff'
          || ''
        }}
    secrets: inherit
